<div class="flex flex-col h-screen antialiased text-gray-200 bg-gray-800">
  {{!-- Header --}}
  <header class="flex-shrink-0 flex items-center justify-between p-2 sm:p-3 bg-gray-900 shadow-md z-10">
    <div class="flex items-center">
      <svg class="w-6 h-6 sm:w-8 sm:h-8 text-sky-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.54.886.061 2.042 2.106 2.106 1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 012.287-.947c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-2.287-.947c.54-.886-.061-2.042-2.106-2.106a1.532 1.532 0 01-2.287.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
      </svg>
      <h1 class="text-lg sm:text-xl font-semibold text-sky-300">Advanced Hex Map Editor</h1>
    </div>
    <div class="text-xs sm:text-sm text-gray-400">
      {{#if currentMapName}}
        <span class="font-medium">{{currentMapName}}</span>
        {{#if currentMapId}}<span class="text-gray-500 ml-1">(ID: {{currentMapId}})</span>{{/if}}
        {{#if isCurrentMapDirty}}<span class="text-yellow-400 ml-2">* Unsaved</span>{{/if}}
      {{else}}
        No Map Loaded
      {{/if}}
    </div>
  </header>

  {{!-- Main Content Area --}}
  <main class="flex-grow flex p-2 sm:p-3 overflow-hidden">
    {{!-- Left Control Panel --}}
    {{> controls}}

    {{!-- Center SVG Map Area --}}
    <section id="center-panel" class="flex-grow flex flex-col bg-gray-850 rounded-lg shadow-inner overflow-hidden mx-2">
      <div id="svg-scroll-container" class="flex-grow overflow-auto bg-gray-900 border border-gray-700 rounded-md relative">
        {{#if hasValidGridDataAndInitialized}}
          {{> hexGrid}}
        {{else}}
          <div class="flex items-center justify-center h-full">
            <p class="text-gray-400 text-lg p-5 text-center">
              {{#if currentMapName}}
                Loading map "{{currentMapName}}"... If this persists, the map data might be corrupted or missing.
              {{else}}
                No map is currently active. Create or open a map using the controls.
              {{/if}}
            </p>
          </div>
        {{/if}}
      </div>
    </section>

    {{!-- Right Panel: Hexploration Info & Event Log --}}
    <aside id="right-panel" class="w-1/3 max-w-xs sm:max-w-sm flex flex-col flex-shrink-0 bg-gray-750 p-2 sm:p-3 ml-0 md:ml-2 rounded-lg shadow-lg overflow-hidden">
      {{!-- Non-scrolling Hexploration Status part --}}
      <div class="flex-shrink-0">
        {{#unless isGM}}
          {{#if isWeatherEnabled}}
            <div class="mb-2 p-1.5 bg-gray-700 rounded-md shadow">
              <div class="flex items-center">
                <input type="checkbox" id="playerSeeCurrentWeatherToggle" name="playerSeeCurrentWeatherToggle" {{#if playerCanSeeCurrentWeather}}checked{{/if}} class="h-4 w-4 text-sky-600 border-gray-500 rounded bg-gray-800 focus:ring-sky-500 focus:ring-offset-gray-700">
                <label for="playerSeeCurrentWeatherToggle" class="ml-2 block text-xs text-gray-300">Show Current Weather</label>
              </div>
            </div>
          {{/if}}
        {{/unless}}

        <h3 class="text-lg font-semibold text-sky-300 mb-2 border-b border-gray-600 pb-1">Hexploration Status</h3>
        <div class="text-sm space-y-1 text-gray-200 mb-2">
          <p><span class="text-gray-400">Mode:</span> <span class="font-semibold capitalize">{{capitalize appMode}}</span> ({{#if isGM}}GM{{else}}Player{{/if}} View)</p>
          {{#if mapInitialized}}
            <p><span class="text-gray-400">Hex Scale:</span> <span class="font-semibold">{{currentMapHexSizeValue}} {{getUnitLabelByKey currentMapHexSizeUnit "distance"}}</span></p>
            <p><span class="text-gray-400">Base Travel:</span> <span class="font-semibold">{{currentMapHexTraversalTimeValue}} {{getUnitLabelByKey currentMapHexTraversalTimeUnit "time"}} / hex</span></p>
          {{else}}
             <p><span class="text-gray-400">Hex Scale:</span> <span class="font-semibold">N/A (No map loaded)</span></p>
             <p><span class="text-gray-400">Base Travel:</span> <span class="font-semibold">N/A (No map loaded)</span></p>
          {{/if}}
          <p><span class="text-gray-400">Time Today:</span> <span class="font-semibold">{{toFixed hexplorationTimeElapsedHoursToday 1}}</span> / 24.0 h</p>
          <p><span class="text-gray-400">KM Today:</span> <span class="font-semibold">{{toFixed hexplorationKmTraveledToday 1}}</span> km</p>
          {{#if isGM}}
            <button id="newHexplorationDayBtn" class="mt-2 w-full px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white text-xs sm:text-sm shadow hover:shadow-md">Start New Day</button>
          {{/if}}
        </div>
        
        {{#if (eq appMode CONST.AppMode.PLAYER)}}
        <hr class="my-2 sm:my-3 border-gray-600">
        <h4 class="text-md font-semibold text-sky-300 mb-1">Active Party Activities:</h4>
        <div id="active-party-activities-display" class="text-xs space-y-0.5 text-gray-300 mb-2">
        {{#if activePartyActivitiesDisplay.length}}
            <ul class="list-none pl-0 space-y-1">
                {{#each activePartyActivitiesDisplay}}
                    {{#with this.details}}
                        <li class="p-1.5 bg-gray-700 rounded-md shadow-sm" title="Source: {{this.source}}">
                            <div class="flex justify-between items-center">
                                <span class="flex items-center">
                                    <span class="mr-2 w-5 text-center">{{this.icon}}</span>
                                    <span>
                                        {{#if (eq ../this.value "_GROUP_")}}
                                            <strong class="text-teal-400">Party is</strong> {{this.name}}
                                        {{else}}
                                            <strong class="text-sky-400">{{../this.value}}</strong> is {{this.name}}
                                        {{/if}}
                                    </span>
                                </span>
                                <button data-action="toggle-off-activity-display" data-activity-id="{{../this.key}}" class="ml-2 px-1.5 py-0.5 text-xs bg-red-600 hover:bg-red-700 text-white rounded-sm" aria-label="Toggle off {{this.name}}">Ã—</button>
                            </div>
                            <p class="text-xxs text-gray-400 mt-0.5">
                                {{this.description}} (Speed x{{toFixed (div 1 this.movementPenaltyFactor) 2}})
                            </p>
                        </li>
                    {{/with}}
                {{/each}}
            </ul>
        {{else}}
            <p class="italic text-gray-400">None.</p>
        {{/if}}
    </div>
        {{/if}}

        <hr class="my-2 sm:my-3 border-gray-600">
        <h4 class="text-md font-semibold text-sky-300 mb-1">Event Log</h4>
      </div>

<div class="p-2 bg-gray-700 rounded-md shadow-lg flex flex-col" style="max-height: 300px;">
    <h4 class="text-sky-300 font-semibold mb-2 text-sm">Event Log (Last {{currentMapEventLog.length}} entries)</h4>
    <div class="overflow-y-auto flex-grow text-xs pr-1 space-y-2">
        {{#if currentMapEventLog.length}}
            {{#each currentMapEventLog}}
                <div class="p-1.5 rounded bg-gray-800 shadow">
                    <div class="flex justify-between items-center mb-0.5">
                        <strong class="text-sky-400">{{typeCapitalized this}}</strong>
                        <span class="text-gray-400 text-xxs">{{formatTimestamp this.timestamp}}</span>
                    </div>

                    {{#if (eq this.type "movement")}}
                        <p class="text-gray-200">
                            Moved {{this.directionText}} from <strong>{{this.fromHexId}}</strong> to <strong>{{this.toHexId}}</strong> ({{getTerrainName this.terrainAtDestination}}).
                        </p>
                        {{#if (isNonZero this.distanceValue)}}
                            <p class="text-gray-300 pl-2 text-xxs">Distance: {{toFixed this.distanceValue 1}} {{getUnitLabelByKey this.distanceUnit 'distance'}}.</p>
                        {{/if}}
                    {{else if (eq this.type "exploration_current")}}
                         <p class="text-gray-200">Explored current hex <strong>{{this.toHexId}}</strong> ({{getTerrainName this.terrainAtDestination}}).</p>
                    {{/if}}
                    
                    <p class="text-gray-300 pl-2 text-xxs">
                        Time Taken: <strong class="text-amber-300">{{toFixed this.totalTimeValue 1}} {{getUnitLabelByKey this.timeUnit 'time'}}</strong>
                        (Base: {{toFixed this.timeBreakdown.base 1}}
                        {{#if (isNonZero this.timeBreakdown.terrainModifier)}}
                            ; Terrain: <span class="{{#if (isPositive this.timeBreakdown.terrainModifier)}}text-red-400{{else}}text-green-400{{/if}}">
                                {{#if (isPositive this.timeBreakdown.terrainModifier)}}+{{/if}}{{toFixed this.timeBreakdown.terrainModifier 1}}
                            </span>
                        {{/if}}
                        {{#if (isNonZero this.timeBreakdown.activityModifier)}}
                            ; Activity: <span class="{{#if (isPositive this.timeBreakdown.activityModifier)}}text-red-400{{else}}text-green-400{{/if}}">
                                {{#if (isPositive this.timeBreakdown.activityModifier)}}+{{/if}}{{toFixed this.timeBreakdown.activityModifier 1}}
                            </span>
                        {{/if}}
                        {{#if this.timeBreakdown.weatherModifier}}
                             {{#if (isNonZero this.timeBreakdown.weatherModifier)}}
                                ; Weather {{this.weatherOnHex.icon}}: <span class="{{#if (isPositive this.timeBreakdown.weatherModifier)}}text-red-400{{else}}text-green-400{{/if}}">
                                    {{#if (isPositive this.timeBreakdown.weatherModifier)}}+{{/if}}{{toFixed this.timeBreakdown.weatherModifier 1}}
                                </span>
                             {{/if}}
                        {{/if}}
                        {{#if (isNonZero this.timeBreakdown.elevationPenalty)}}
                            ; Elevation ({{#if (isPositive this.elevationChange)}}+{{/if}}{{this.elevationChange}}m): <span class="text-red-400">
                                +{{toFixed this.timeBreakdown.elevationPenalty 1}}
                            </span>
                        {{/if}}
                        )
                    </p>

                    {{#if this.activitiesActive.length}}
                        <p class="text-gray-400 pl-3 text-xxs italic">Active: {{#each this.activitiesActive}}{{@key}}{{#unless @last}}, {{/unless}}{{/each}}</p>
                    {{/if}}

                    {{#if this.encounterOnEnter.triggered}}
                        <p class="text-yellow-400 pl-2 text-xxs">
                            Encounter entering {{this.toHexId}}: 
                            {{#if this.encounterOnEnter.markedByGM}}
                                Marked as '{{this.encounterOnEnter.featureName}}' {{this.encounterOnEnter.featureIcon}}.
                            {{else}}
                                Skipped by GM ({{this.encounterOnEnter.reasonSkipped}}).
                            {{/if}}
                        </p>
                    {{/if}}

                    {{#if this.encountersOnDiscover.length}}
                        {{#each this.encountersOnDiscover}}
                            <p class="text-yellow-400 pl-2 text-xxs">
                                Discovery at {{this.hexId}}:
                                {{#if this.markedByGM}}
                                    Marked as '{{this.featureName}}' {{this.featureIcon}}.
                                {{else}}
                                    Skipped by GM ({{this.reasonSkipped}}).
                                {{/if}}
                            </p>
                        {{/each}}
                    {{/if}}
                    
                    {{#if this.newlyDiscoveredHexIds.length}}
                         <p class="text-gray-400 pl-3 text-xxs italic">New Hexes Discovered: {{this.newlyDiscoveredHexIds}}</p>
                    {{/if}}

                </div>
            {{/each}}
        {{else}}
            <p class="text-gray-400 text-center">No events logged for this map yet.</p>
        {{/if}}
    </div>
</div>
    </aside>
  </main>
  {{> travelAnimationPopup travelAnimation}}
</div>