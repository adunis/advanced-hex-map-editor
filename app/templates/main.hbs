{{! app/templates/main.hbs }}
<div class="min-h-screen bg-gray-800 text-white p-2 sm:p-4 flex flex-col w-full h-full overflow-hidden">
  <header class="mb-2 sm:mb-4 text-center flex-shrink-0">
    <h1 class="text-2xl sm:text-3xl font-bold text-sky-400">Advanced Hex Map Editor</h1>
    {{#if currentMapName}}
      <h2 class="text-md sm:text-lg text-sky-200 mt-1">Current Map: <span class="font-semibold">{{currentMapName}}</span> {{#if isCurrentMapDirty}}(Unsaved*){{/if}}</h2>
    {{else}}
      <h2 class="text-md sm:text-lg text-sky-200 mt-1">No Map Loaded</h2>
    {{/if}}
  </header>
  
  <div class="flex flex-grow overflow-hidden h-[calc(100vh-90px)] sm:h-[calc(100vh-110px)]">
    
    {{!-- Left Panel: Controls & Settings --}}
    <aside id="left-panel" class="w-1/3 max-w-xs sm:max-w-sm flex-shrink-0 bg-gray-750 p-2 sm:p-3 overflow-y-auto mr-2 rounded-lg shadow-lg"> 
      {{> controls }}
    </aside>

    {{!-- Center Panel: Map Display --}}
    <main id="center-panel" class="flex-grow bg-gray-850 p-1 rounded-lg overflow-auto relative shadow-lg"> 
      {{#if hasValidGridDataAndInitialized}}
        {{> hexGrid }}
      {{else}}
        <div class="flex items-center justify-center h-full">
            <p class="text-gray-400 text-lg p-4 text-center">
              {{#if currentMapName}}
                Loading map data for '{{currentMapName}}'...
                <br><span class="text-sm">(If this persists, the map might be empty or corrupted)</span>
              {{else if isGM}}
                Please create a new map or open an existing one using the controls on the left.
              {{else}}
                Waiting for the Game Master to activate or share a map.
              {{/if}}
            </p>
        </div>
      {{/if}}
    </main>

    {{!-- Right Panel: Hexploration Info & Event Log --}}
    <aside id="right-panel" class="w-1/3 max-w-xs sm:max-w-sm flex flex-col flex-shrink-0 bg-gray-750 p-2 sm:p-3 ml-2 rounded-lg shadow-lg overflow-hidden">
      {{!-- Non-scrolling Hexploration Status part --}}
      <div class="flex-shrink-0"> 
        <h3 class="text-lg font-semibold text-sky-300 mb-2 border-b border-gray-600 pb-1">Hexploration Status</h3>
        <div class="text-sm space-y-1 text-gray-200 mb-2">
          <p><span class="text-gray-400">Mode:</span> <span class="font-semibold capitalize">{{capitalize appMode}}</span> ({{#if isGM}}GM{{else}}Player{{/if}} View)</p>
          <p><span class="text-gray-400">Time Today:</span> <span class="font-semibold">{{toFixed hexplorationTimeElapsedHoursToday 1}}</span> / 24.0 h</p>
          <p><span class="text-gray-400">KM Today:</span> <span class="font-semibold">{{hexplorationKmTraveledToday}}</span> km</p>
          {{#if isGM}}
            <button id="newHexplorationDayBtn" class="mt-2 w-full px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white text-xs sm:text-sm shadow hover:shadow-md">Start New Day</button>
          {{/if}}
        </div>
        <hr class="my-2 sm:my-3 border-gray-600">
        <h4 class="text-md font-semibold text-sky-300 mb-1">Event Log</h4>
      </div>

      {{!-- Scrolling Event Log part --}}
      <div id="map-event-log" class="flex-grow text-xs text-gray-200 space-y-2 overflow-y-auto bg-gray-800 p-1.5 sm:p-2 rounded mt-1 border border-gray-600">
        {{#if currentMapEventLog.length}}
          {{#each currentMapEventLog}}
            <div class="p-1.5 bg-gray-700 rounded-sm shadow hover:bg-gray-650 transition-colors duration-150">
              <p class="font-semibold text-sky-400">{{capitalizeFirst this.type}}: Party {{#if this.movementVerb}}{{this.movementVerb}}{{else}}moved{{/if}} {{this.direction}} to hex {{this.to}}</p>
              <p><span class="text-gray-400">From:</span> {{this.from}}, <span class="text-gray-400">Target Terrain:</span> {{this.targetTerrain}}</p>
              <p><span class="text-gray-400">Distance:</span> {{this.distanceKm}}km. <span class="text-gray-400">Base Time:</span> {{toFixed this.baseTime 1}}h.</p>
              
              {{!-- Calculate terrainEffect and only show if significant --}}
              {{assign "terrainEffectVal" (subtract this.terrainModifiedTime this.baseTime)}}
              {{assign "absTerrainEffectVal" (abs terrainEffectVal)}}

              {{#if (compare absTerrainEffectVal ">" 0.01)}} {{!-- Use compare helper --}}
                <p><span class="text-gray-400">Terrain ({{this.targetTerrain}}):</span> 
                  <span class="{{#if (compare terrainEffectVal "<" 0)}}text-green-400{{else}}text-red-400{{/if}} font-semibold">
                    {{#if (compare terrainEffectVal "<" 0)}}-{{else}}+{{/if}}{{toFixed absTerrainEffectVal 1}}h
                  </span>
                </p>
              {{/if}}
              
              {{#if (compare this.elevationPenalty ">" 0.01)}} {{!-- Use compare helper --}}
                 <p><span class="text-gray-400">Elevation ({{#if (compare this.elevationChange ">" 0)}}+{{/if}}{{this.elevationChange}}m):</span> 
                   <span class="text-red-400 font-semibold">+{{toFixed this.elevationPenalty 1}}h</span>
                 </p>
              {{/if}}
              <p class="font-bold text-white">Total Time for Leg: {{toFixed this.totalTime 1}}h.</p>
              {{#if this.encounterStatus}}
                {{! Use compare helper for this condition as well }}
                {{#if (compare this.encounterStatus "!==" "No significant event on entering hex.")}}
                     <p class="text-yellow-300 italic mt-0.5">{{this.encounterStatus}}</p>
                {{/if}}
              {{/if}}
              <p class="text-gray-500 text-xxs pt-0.5 text-right">{{this.timestamp}}</p>
            </div>
          {{/each}}
        {{else}}
          <p class="italic text-gray-400 p-2 text-center">No travel events recorded for this map yet.</p>
        {{/if}}
      </div>
    </aside>
  </div>
  
  <input type="file" id="fileLoadInput" accept=".json, .hexmap" style="display: none;" />
  <footer class="mt-auto pt-1 sm:pt-2 text-center text-gray-500 text-xs flex-shrink-0">
    {{#if mapInitialized}}Grid: {{currentGridWidth}}x{{currentGridHeight}}{{else}}No map initialized.{{/if}}
    <span class="mx-1 sm:mx-2">|</span> AHME v0.2.1 {{!-- Example version update --}}
  </footer>
</div>